<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width,
                 initial-scale=1.0,
                 maximum-scale=1.0,
                 minimum-scale=1.0,
                 user-scalable=no">
  <title>StickShot Mobile Redux</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">
  <style>
    /* ───── disable zoom/select ───── */
    html,body,canvas,#controls,button {
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    :root {
      --bg: #0d0d0d;
      --fg: #f1faee;
      --accent: #e63946;
      --glass: rgba(255,255,255,0.12);
      --hit: #ffd100;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
    html, body { width:100%; height:100%; overflow:hidden; background:var(--bg); }
    canvas { display:block; width:100%; height:100%; }

    /* ───── OVERLAYS ───── */
    .overlay, #gameOver {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(13,13,13,0.85); backdrop-filter:blur(10px);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      color:var(--fg); text-align:center; z-index:20; opacity:0;
      animation:fadeIn 0.6s forwards;
    }
    .overlay.fade-out { animation:fadeOut 0.6s forwards; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    @keyframes fadeOut { to{opacity:0; transform:scale(0.8);} }

    .overlay h1 { font-size:3rem; margin-bottom:.5rem; }
    .overlay p {
      font-size:1.2rem;
      animation:blink 1.5s infinite;
    }
    @keyframes blink {
      0%,50%,100%{opacity:1;}
      25%,75%{opacity:0.3;}
    }
    .overlay small { opacity:.7; font-size:.8rem; margin-top:1rem; }

    /* ───── HUD ───── */
    #hud {
      position:absolute; top:1rem; left:1rem; right:1rem;
      display:flex; justify-content:space-between; z-index:10;
    }
    .hud-box {
      background:var(--glass); backdrop-filter:blur(4px);
      padding:.5rem 1rem; border-radius:.6rem;
      display:flex; align-items:center; color:var(--fg);
    }
    #hp-bar-container {
      width:120px; height:16px;
      background:rgba(255,255,255,0.2);
      border-radius:8px; overflow:hidden;
      margin-right:.5rem;
    }
    #hp-bar {
      width:100%; height:100%;
      background:var(--accent);
      transition:width 0.3s ease;
    }

    /* ───── CONTROLS ───── */
    #controls {
      position:absolute; bottom:1rem; left:1rem; right:1rem;
      display:flex; justify-content:space-between;
      z-index:15; pointer-events:none;
    }
    #dpad {
      display:grid;
      grid-template-areas:
        ". up ."
        "left down right";
      grid-gap:.6rem; pointer-events:auto;
    }
    #dpad button, #shoot {
      width:64px; height:64px;
      background:var(--glass); border:none; border-radius:1rem;
      color:var(--fg); font-size:1.6rem;
      box-shadow:0 4px 8px rgba(0,0,0,0.4);
      transition:transform .1s, background .3s;
      user-select:none;
    }
    #dpad button:hover, #shoot:hover {
      background:rgba(230,57,70,0.8);
    }
    #dpad button:active, #shoot:active {
      transform:scale(.92);
    }
    #up    { grid-area:up; }
    #left  { grid-area:left; }
    #down  { grid-area:down; }
    #right { grid-area:right; }
    #shoot {
      pointer-events:auto;
      background:var(--accent);
      border-radius:50%;
    }

    /* ───── GAME OVER ───── */
    #gameOver h2 { font-size:2.5rem; margin-bottom:.5rem; }
    #gameOver p  { font-size:1.2rem; margin-bottom:1rem; }
    #gameOver ol {
      width:80%; max-width:300px;
      list-style:none; padding:0; margin-bottom:1rem;
      max-height:180px; overflow-y:auto;
    }
    #gameOver ol li {
      background:var(--glass);
      padding:.5rem; border-radius:.5rem;
      margin-bottom:.5rem;
      display:flex; justify-content:space-between;
      font-size:.9rem;
    }
    #gameOver input, #gameOver button {
      width:80%; max-width:300px;
      padding:.7rem 1rem; margin:.3rem 0;
      border:none; border-radius:.6rem;
      font-size:1rem;
    }
    #gameOver input {
      background:var(--glass); color:var(--fg);
    }
    #gameOver button {
      background:var(--accent);
      color:var(--fg);
      cursor:pointer;
      transition:background .3s, transform .1s;
    }
    #gameOver button:hover {
      background:#d62828;
    }
  </style>
</head>
<body>
  <!-- START OVERLAY -->
  <div class="overlay" id="startOverlay">
    <h1>StickShot Redux</h1>
    <p>Tap to Start</p>
    <small>Allow motion & orientation</small>
  </div>

  <!-- CANVAS -->
  <canvas id="gameCanvas"></canvas>

  <!-- HUD -->
  <div id="hud">
    <div class="hud-box">
      <div id="hp-bar-container"><div id="hp-bar"></div></div>
      <span id="hp-text">100</span>
    </div>
    <div class="hud-box">Score <span id="score">0</span></div>
  </div>

  <!-- CONTROLS -->
  <div id="controls">
    <div id="dpad">
      <button id="up">▲</button>
      <button id="left">◀</button>
      <button id="down">▼</button>
      <button id="right">▶</button>
    </div>
    <button id="shoot">Shoot</button>
  </div>

  <!-- GAME OVER -->
  <div class="overlay" id="gameOver">
    <h2>Game Over</h2>
    <p>Your Score: <span id="finalScore">0</span></p>
    <ol id="highScores"></ol>
    <input id="playerName" placeholder="Your Name" maxlength="12">
    <button id="saveScore">Save Score</button>
    <button id="restartGame">Restart</button>
  </div>

  <!-- THREE.JS -->
  <script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
  <script>
  // ───── BASIC SETUP ─────
  const canvas   = document.getElementById('gameCanvas'),
        scene    = new THREE.Scene(),
        camera   = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000),
        renderer = new THREE.WebGLRenderer({canvas, antialias:true});
  renderer.setSize(innerWidth, innerHeight);
  window.addEventListener('resize', () => {
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });

  // lights & floor
  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const dir = new THREE.DirectionalLight(0xffffff, 0.7);
  dir.position.set(5,10,4);
  scene.add(dir);
  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(400,400),
    new THREE.MeshPhongMaterial({color:0x222222})
  );
  floor.rotation.x = -Math.PI/2;
  scene.add(floor);

  // ───── UTILS & STATE ─────
  const clamp  = (v,m,M) => v<m?m:v>M?M:v,
        HS_KEY = 'stickShotHighScores';
  let player,
      enemies   = [],
      bullets   = [],
      particles = [],
      moveF=0, moveB=0, moveL=0, moveR=0,
      yaw=0, score=0, hp=100,
      spawnDelay=1800, lastSpawn=0, lastTime=0,
      running=false, gameOver=false,
      speed=8;

  // Audio beeps
  const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  function beep(freq,dur){
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.frequency.value = freq; g.gain.value=0.1;
    o.start(); o.stop(audioCtx.currentTime+dur);
  }

  // ───── FACTORIES ─────
  function makeStick(col){
    const g=new THREE.Group(), mat=new THREE.MeshPhongMaterial({color:col});
    const head=new THREE.Mesh(new THREE.SphereGeometry(.35,12,12), mat);
    head.position.y=2.05; g.add(head);
    const torso=new THREE.Mesh(new THREE.CylinderGeometry(.12,.12,1.5,8), mat);
    torso.position.y=1.25; g.add(torso);
    const armGeo=new THREE.CylinderGeometry(.06,.06,1,8);
    const lArm=new THREE.Mesh(armGeo,mat);
    lArm.position.set(-.7,1.7,0); lArm.rotation.z=Math.PI/2;
    const rArm=lArm.clone(); rArm.position.x=.7;
    g.add(lArm,rArm);
    const gun=new THREE.Mesh(new THREE.BoxGeometry(.6,.08,.08), mat);
    gun.position.set(.4,0,0);
    rArm.add(gun);
    const legGeo=new THREE.CylinderGeometry(.06,.06,1,8);
    const lLeg=new THREE.Mesh(legGeo, mat);
    lLeg.position.set(-.25,.5,0);
    const rLeg=lLeg.clone(); rLeg.position.x=.25;
    g.add(lLeg, rLeg);
    return g;
  }
  function makeEnemy(){
    const e=makeStick(0xff0000);
    const eyesMat=new THREE.MeshBasicMaterial({color:0x000000});
    const eyeGeo=new THREE.SphereGeometry(.07,6,6);
    const lEye=new THREE.Mesh(eyeGeo, eyesMat);
    lEye.position.set(-.12,2.15,.33);
    const rEye=lEye.clone(); rEye.position.x=.12;
    const sm=new THREE.Mesh(
      new THREE.TorusGeometry(.25,.04,6,12,Math.PI),
      eyesMat
    );
    sm.position.set(0,2.0,.33);
    sm.rotation.x=Math.PI;
    const pony=new THREE.Mesh(
      new THREE.CylinderGeometry(.05,.08,.6,6),
      new THREE.MeshPhongMaterial({color:0xff0000})
    );
    pony.position.set(0,2.1,-.35);
    pony.rotation.x=Math.PI/2;
    e.add(lEye,rEye,sm,pony);
    e.scale.set(1.3,1.3,1.3);
    e.userData.speed = 2;
    return e;
  }

  // ───── INPUT ─────
  const btns = {
    up: document.getElementById('up'),
    down: document.getElementById('down'),
    left: document.getElementById('left'),
    right: document.getElementById('right'),
    shoot: document.getElementById('shoot')
  };
  function bind(b, setter){
    b.addEventListener('pointerdown', e=>{ e.preventDefault(); setter(1) });
    b.addEventListener('pointerup',   ()=>setter(0));
    b.addEventListener('pointerleave',()=>setter(0));
  }
  bind(btns.up,    v=>moveF=v);
  bind(btns.down,  v=>moveB=v);
  bind(btns.left,  v=>moveL=v);
  bind(btns.right, v=>moveR=v);

  window.addEventListener('keydown', e=>{
    if(e.repeat) return;
    if(e.key.match(/w|ArrowUp/))    moveF=1;
    if(e.key.match(/s|ArrowDown/))  moveB=1;
    if(e.key.match(/a|ArrowLeft/))  moveL=1;
    if(e.key.match(/d|ArrowRight/)) moveR=1;
  });
  window.addEventListener('keyup', e=>{
    if(e.key.match(/w|ArrowUp/))    moveF=0;
    if(e.key.match(/s|ArrowDown/))  moveB=0;
    if(e.key.match(/a|ArrowLeft/))  moveL=0;
    if(e.key.match(/d|ArrowRight/)) moveR=0;
  });

  btns.shoot.addEventListener('pointerdown', ()=>{
    if(running && !gameOver){
      shoot();
      beep(600,0.05);
    }
  });

  // ───── ORIENTATION ─────
  function handleOrient(e){ yaw = THREE.MathUtils.degToRad(e.alpha||0); }
  async function requestMotion(){
    try {
      if(DeviceMotionEvent.requestPermission)       await DeviceMotionEvent.requestPermission();
      if(DeviceOrientationEvent.requestPermission)  await DeviceOrientationEvent.requestPermission();
    }catch{}
    window.addEventListener('deviceorientation', handleOrient);
  }

  // ───── GAME FLOW ─────
  const hpBar     = document.getElementById('hp-bar'),
        hpText    = document.getElementById('hp-text'),
        scoreEl   = document.getElementById('score'),
        startO    = document.getElementById('startOverlay'),
        gameO     = document.getElementById('gameOver'),
        finalEl   = document.getElementById('finalScore'),
        hsList    = document.getElementById('highScores'),
        nameIn    = document.getElementById('playerName'),
        saveBtn   = document.getElementById('saveScore'),
        restartBtn= document.getElementById('restartGame');

  startO.addEventListener('pointerdown', async ()=>{
    await requestMotion();
    startO.classList.add('fade-out');
    startO.addEventListener('animationend', ()=>startO.style.display='none');
    initGame();
    running=true;
    lastTime=performance.now();
    requestAnimationFrame(loop);
  });

  restartBtn.addEventListener('click', ()=>{
    gameO.style.display='none';
    gameO.classList.remove('fade-in');
    initGame();
    running=true;
    lastTime=performance.now();
    requestAnimationFrame(loop);
  });

  saveBtn.addEventListener('click', saveHighScore);

  function initGame(){
    enemies.forEach(e=>scene.remove(e)); enemies=[];
    bullets.forEach(b=>scene.remove(b.mesh)); bullets=[];
    particles.forEach(p=>scene.remove(p.mesh)); particles=[];
    score=0; hp=100; spawnDelay=1800;
    hpBar.style.width='100%'; hpText.textContent=hp;
    scoreEl.textContent=score;
    gameOver=false;
    nameIn.disabled=false; saveBtn.disabled=false; nameIn.value='';
    if(player) scene.remove(player);
    player=makeStick(0x00ff66);
    player.position.set(0,0,0);
    scene.add(player);
    camera.position.set(0,5,-10);
    camera.lookAt(player.position);
  }

  function spawnEnemy(){
    const e=makeEnemy();
    const ang=Math.random()*Math.PI*2, dist=60;
    e.position.set(Math.cos(ang)*dist,0,Math.sin(ang)*dist);
    scene.add(e);
    enemies.push(e);
    spawnDelay = Math.max(400, spawnDelay*0.95);
  }

  function shoot(){
    const dir=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
    const m=new THREE.Mesh(
      new THREE.SphereGeometry(.1,8,8),
      new THREE.MeshBasicMaterial({color:0xffff00})
    );
    m.position.copy(player.position)
     .add(new THREE.Vector3(0,1.5,0))
     .add(dir.clone().multiplyScalar(1.2));
    scene.add(m);
    bullets.push({mesh:m, dir, life:0});
  }

  function loop(ts){
    const dt=(ts-lastTime)/1000;
    lastTime=ts;
    if(running){
      if(ts-lastSpawn>spawnDelay){
        spawnEnemy(); lastSpawn=ts;
      }
      // — movement —
      const dx = (moveR?1:0)-(moveL?1:0),
            dz = (moveB?1:0)-(moveF?1:0);
      player.position.x += dx*speed*dt;
      player.position.z += dz*speed*dt;
      player.rotation.y = -yaw;
      player.position.x = clamp(player.position.x,-50,50);
      player.position.z = clamp(player.position.z,-50,50);

      // — bullets —
      bullets = bullets.filter(b=>{
        b.mesh.position.add(b.dir.clone().multiplyScalar(40*dt));
        b.life += dt;
        if(b.life>2.5){
          scene.remove(b.mesh);
          return false;
        }
        return true;
      });

      // — particles —
      particles = particles.filter(p=>{
        p.mesh.position.add(p.vel.clone().multiplyScalar(dt));
        p.vel.y -= 9.8*dt;
        p.life += dt;
        if(p.life>0.6){
          scene.remove(p.mesh);
          return false;
        }
        return true;
      });

      // — enemies —
      enemies = enemies.filter(e=>{
        const toP = new THREE.Vector3().subVectors(player.position,e.position).normalize();
        e.position.add(toP.multiplyScalar(e.userData.speed*dt));
        e.lookAt(player.position);

        if(e.position.distanceTo(player.position)<1){
          hp = Math.max(0, hp-10);
          hpText.textContent = hp;
          hpBar.style.width = hp+'%';
          beep(200,0.1);
          scene.remove(e);
          return false;
        }
        for(let i=0;i<bullets.length;i++){
          if(bullets[i].mesh.position.distanceTo(e.position)<1.2){
            // explosion particles
            for(let k=0;k<8;k++){
              const pt=new THREE.Mesh(
                new THREE.SphereGeometry(.05,6,6),
                new THREE.MeshBasicMaterial({color:0xffd100})
              );
              pt.position.copy(e.position);
              const vel=new THREE.Vector3(
                Math.random()*2-1,
                Math.random()*2,
                Math.random()*2-1
              ).normalize().multiplyScalar(5);
              particles.push({mesh:pt, vel, life:0});
              scene.add(pt);
            }
            beep(300,0.1);
            score++;
            scoreEl.textContent=score;
            scene.remove(e);
            scene.remove(bullets[i].mesh);
            bullets.splice(i,1);
            return false;
          }
        }
        return true;
      });

      if(hp<=0 && !gameOver) endGame();

      const off=new THREE.Vector3(
        -Math.sin(yaw)*10,
        5,
        -Math.cos(yaw)*10
      );
      camera.position.copy(player.position).add(off);
      camera.lookAt(player.position);
    }

    renderer.render(scene,camera);
    if(running) requestAnimationFrame(loop);
  }

  function endGame(){
    running=false;
    gameOver=true;
    finalEl.textContent=score;
    fillHighScores();
    gameO.style.display='flex';
    gameO.classList.add('fade-in');
  }
  function fillHighScores(){
    const arr=JSON.parse(localStorage.getItem(HS_KEY)||'[]')
                .sort((a,b)=>b.s-a.s)
                .slice(0,10);
    hsList.innerHTML='';
    arr.forEach(({n,s})=>{
      const li=document.createElement('li');
      li.innerHTML=`<span>${n}</span><span>${s}</span>`;
      hsList.appendChild(li);
    });
  }
  function saveHighScore(){
    const n=nameIn.value.trim()||'Anon';
    const arr=JSON.parse(localStorage.getItem(HS_KEY)||'[]');
    arr.push({n,s:score});
    arr.sort((a,b)=>b.s-a.s);
    arr.splice(10);
    localStorage.setItem(HS_KEY, JSON.stringify(arr));
    nameIn.disabled=true;
    saveBtn.disabled=true;
    fillHighScores();
  }
  </script>
</body>
</html>