<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width,
                 initial-scale=1.0,
                 maximum-scale=1.0,
                 minimum-scale=1.0,
                 user-scalable=no">
  <title>Stick Shot Mobile</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">
  <style>
    /* ────── disable zoom/selection ────── */
    html, body, canvas, #controls, button {
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    :root {
      --bg: #0d0d0d;
      --fg: #f1faee;
      --accent: #e63946;
      --glass: rgba(255,255,255,0.12);
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
    html, body { width:100%; height:100%; overflow:hidden; background:var(--bg); }
    canvas { display:block; width:100%; height:100%; }

    /* START OVERLAY */
    .overlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(13,13,13,0.8); backdrop-filter:blur(8px);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      color:var(--fg); text-align:center; padding:2rem; z-index:20;
    }
    .overlay h1 { font-size:3rem; margin-bottom:.5rem; font-weight:600; }
    .overlay p  { font-size:1.25rem; margin-bottom:.5rem; }
    .overlay small{ opacity:.7; font-size:.8rem; }

    /* HUD */
    #hud {
      position:absolute; top:1rem; left:1rem; right:1rem;
      display:flex; justify-content:space-between; z-index:10;
    }
    .hud-box {
      background:var(--glass); backdrop-filter:blur(4px);
      padding:.4rem 1rem; border-radius:.6rem; color:var(--fg);
      font-weight:600; font-size:1.1rem;
    }

    /* CONTROLS */
    #controls {
      position:absolute; bottom:1rem; left:1rem; right:1rem;
      display:flex; justify-content:space-between; z-index:15; pointer-events:none;
    }
    #dpad {
      display:grid;
      grid-template-areas:
        ". up ."
        "left down right";
      grid-gap:.6rem; pointer-events:auto;
    }
    #dpad button, #shoot {
      width:64px; height:64px;
      background:var(--glass); border:none; border-radius:1rem;
      color:var(--fg); font-size:1.6rem; font-weight:600;
      box-shadow:0 4px 8px rgba(0,0,0,.4);
      transition:transform .1s; user-select:none;
    }
    #dpad button:active, #shoot:active { transform:scale(.9); }
    #up    { grid-area:up; }
    #down  { grid-area:down; }
    #left  { grid-area:left; }
    #right { grid-area:right; }
    #shoot {
      pointer-events:auto;
      background:var(--accent); border-radius:50%;
    }

    /* GAME OVER */
    #gameOver {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(13,13,13,0.8); backdrop-filter:blur(8px);
      display:none; flex-direction:column; align-items:center; justify-content:center;
      color:var(--fg); text-align:center; padding:2rem; z-index:20;
    }
    #gameOver h2 { font-size:2.25rem; margin-bottom:.5rem; }
    #gameOver p  { font-size:1.25rem; margin-bottom:1rem; }
    #gameOver ol {
      width:100%; max-width:340px; list-style:none;
      max-height:180px; overflow-y:auto; margin:0 auto 1rem; padding:0;
    }
    #gameOver ol li {
      background:var(--glass); padding:.5rem; border-radius:.5rem;
      display:flex; justify-content:space-between; font-size:.9rem;
    }
    #gameOver input, #gameOver button {
      width:100%; max-width:340px;
      padding:.7rem 1rem; margin:.3rem 0; border:none; border-radius:.6rem;
      font-size:1rem;
    }
    #gameOver input { background:var(--glass); color:var(--fg); }
    #gameOver button {
      background:var(--accent); color:var(--fg); cursor:pointer;
      transition:transform .1s;
    }
    #gameOver button:active { transform:scale(.96); }
  </style>
</head>
<body>
  <div class="overlay" id="startOverlay">
    <h1>Stick Shot</h1>
    <p>Tap Anywhere to Start</p>
    <small>Allow motion & orientation access</small>
  </div>

  <canvas id="gameCanvas"></canvas>

  <div id="hud">
    <div class="hud-box">HP <span id="hp">100</span></div>
    <div class="hud-box">Score <span id="score">0</span></div>
  </div>

  <div id="controls">
    <div id="dpad">
      <button id="up">▲</button>
      <button id="left">◀</button>
      <button id="down">▼</button>
      <button id="right">▶</button>
    </div>
    <button id="shoot">Shoot</button>
  </div>

  <div id="gameOver">
    <h2>Game Over</h2>
    <p>Your Score: <span id="finalScore">0</span></p>
    <ol id="highScores"></ol>
    <input id="playerName" placeholder="Enter your name" maxlength="12">
    <button id="saveScore">Save Score</button>
    <button id="restartGame">Restart</button>
  </div>

  <script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
  <script>
  // ───── BASIC SETUP ─────
  const canvas = document.getElementById('gameCanvas');
  const scene  = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, .1, 1000);
  const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
  renderer.setSize(innerWidth, innerHeight);
  window.addEventListener('resize', ()=>{
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });

  // lights & floor
  scene.add(new THREE.AmbientLight(0xffffff, .6));
  const dir = new THREE.DirectionalLight(0xffffff, .7);
  dir.position.set(5,10,4); scene.add(dir);
  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(400,400),
    new THREE.MeshPhongMaterial({color:0x222222})
  );
  floor.rotation.x = -Math.PI/2;
  scene.add(floor);

  // ───── UTILS & STATE ─────
  const clamp     = (v, min, max) => v<min ? min : v>max ? max : v;
  const HS_KEY    = 'stickshotHighScores';

  let player, enemies = [], bullets = [];
  let moveF=0, moveB=0, moveL=0, moveR=0;
  let yaw = 0;
  let score=0, hp=100;
  let spawnDelay=1800, lastSpawn=0, lastTime=0;
  let running=false, gameOver=false;
  const speed = 8;

  // ───── FACTORIES ─────
  function makeStick(color){
    const g = new THREE.Group();
    const mat = new THREE.MeshPhongMaterial({color});
    const head = new THREE.Mesh(new THREE.SphereGeometry(.35,12,12), mat);
    head.position.y = 2.05; g.add(head);
    const torso = new THREE.Mesh(new THREE.CylinderGeometry(.12,.12,1.5,8), mat);
    torso.position.y = 1.25; g.add(torso);
    const armGeo = new THREE.CylinderGeometry(.06,.06,1,8);
    const lArm = new THREE.Mesh(armGeo, mat);
    lArm.position.set(-.7,1.7,0); lArm.rotation.z = Math.PI/2;
    const rArm = lArm.clone(); rArm.position.x = .7;
    g.add(lArm,rArm);
    // attach gun to rArm
    const gun = new THREE.Mesh(new THREE.BoxGeometry(.6,.08,.08), mat);
    gun.position.set(.4,0,0); rArm.add(gun);
    const legGeo = new THREE.CylinderGeometry(.06,.06,1,8);
    const lLeg = new THREE.Mesh(legGeo, mat);
    lLeg.position.set(-.25, .5, 0);
    const rLeg = lLeg.clone(); rLeg.position.x = .25;
    g.add(lLeg, rLeg);
    return g;
  }
  function makeEnemy(){
    const e = makeStick(0xff0000);
    // face: eyes
    const eyesMat = new THREE.MeshBasicMaterial({color:0x000000});
    const eyeGeo = new THREE.SphereGeometry(.07,6,6);
    const lEye = new THREE.Mesh(eyeGeo, eyesMat);
    lEye.position.set(-.12,2.15,.33);
    const rEye = lEye.clone(); rEye.position.x = .12;
    const sm = new THREE.Mesh(
      new THREE.TorusGeometry(.25,.04,6,12,Math.PI),
      eyesMat
    );
    sm.position.set(0,2.0,.33); sm.rotation.x = Math.PI;
    // ponytail
    const pony = new THREE.Mesh(
      new THREE.CylinderGeometry(.05,.08,.6,6),
      new THREE.MeshPhongMaterial({color:0xff0000})
    );
    pony.position.set(0,2.1,-.35);
    pony.rotation.x = Math.PI/2;
    e.add(lEye, rEye, sm, pony);
    e.scale.set(1.3,1.3,1.3);
    e.userData.speed = 2;
    return e;
  }

  // ───── INPUT HANDLING ─────
  const btnUp    = document.getElementById('up'),
        btnDown  = document.getElementById('down'),
        btnLeft  = document.getElementById('left'),
        btnRight = document.getElementById('right'),
        btnShoot = document.getElementById('shoot');

  function bindHold(btn, setter){
    btn.addEventListener('pointerdown', e=>{ e.preventDefault(); setter(1) });
    btn.addEventListener('pointerup',    ()=>setter(0));
    btn.addEventListener('pointerleave', ()=>setter(0));
  }
  bindHold(btnUp,    v=>moveF=v);
  bindHold(btnDown,  v=>moveB=v);
  bindHold(btnLeft,  v=>moveL=v);
  bindHold(btnRight, v=>moveR=v);

  window.addEventListener('keydown', e=>{
    if(e.repeat) return;
    if(e.key==='w'||e.key==='ArrowUp')    moveF=1;
    if(e.key==='s'||e.key==='ArrowDown')  moveB=1;
    if(e.key==='a'||e.key==='ArrowLeft')  moveL=1;
    if(e.key==='d'||e.key==='ArrowRight') moveR=1;
  });
  window.addEventListener('keyup', e=>{
    if(e.key==='w'||e.key==='ArrowUp')    moveF=0;
    if(e.key==='s'||e.key==='ArrowDown')  moveB=0;
    if(e.key==='a'||e.key==='ArrowLeft')  moveL=0;
    if(e.key==='d'||e.key==='ArrowRight') moveR=0;
  });

  btnShoot.addEventListener('pointerdown', ()=>{
    if(running && !gameOver) shoot();
  });

  // ───── ORIENTATION ─────
  function handleOrientation(e){
    yaw = THREE.MathUtils.degToRad(e.alpha||0);
  }
  async function requestMotion(){
    try {
      if(DeviceMotionEvent?.requestPermission) await DeviceMotionEvent.requestPermission();
      if(DeviceOrientationEvent?.requestPermission) await DeviceOrientationEvent.requestPermission();
    } catch{}
    window.addEventListener('deviceorientation', handleOrientation);
  }

  // ───── GAME FLOW ─────
  const startO = document.getElementById('startOverlay'),
        gameO  = document.getElementById('gameOver'),
        hpEl   = document.getElementById('hp'),
        scEl   = document.getElementById('score'),
        finalEl= document.getElementById('finalScore'),
        hsList = document.getElementById('highScores'),
        nameIn = document.getElementById('playerName'),
        saveBtn= document.getElementById('saveScore'),
        restartBtn = document.getElementById('restartGame');

  startO.addEventListener('pointerdown', async ()=>{
    await requestMotion();
    initGame();
    startO.style.display = 'none';
    running = true;
    lastTime = performance.now();
    requestAnimationFrame(loop);
  });
  restartBtn.addEventListener('click', ()=>{
    gameO.style.display = 'none';
    initGame();
    running = true;
    lastTime = performance.now();
    requestAnimationFrame(loop);
  });
  saveBtn.addEventListener('click', saveHighScore);

  function initGame(){
    // clean up
    enemies.forEach(e=>scene.remove(e));
    bullets.forEach(b=>scene.remove(b.mesh));
    enemies = []; bullets = [];
    // reset stats
    score = 0; hp = 100;
    spawnDelay = 1800;
    hpEl.textContent = hp;
    scEl.textContent = score;
    gameOver = false;
    nameIn.disabled = false;
    saveBtn.disabled = false;
    nameIn.value = '';

    // create player
    if(player) scene.remove(player);
    player = makeStick(0x00ff66);
    player.position.set(0,0,0);
    scene.add(player);

    // initial camera
    camera.position.set(0,5,-10);
    camera.lookAt(player.position);
  }

  function spawnEnemy(){
    const e = makeEnemy();
    const ang = Math.random()*Math.PI*2;
    const dist = 60;
    e.position.set(Math.cos(ang)*dist, 0, Math.sin(ang)*dist);
    scene.add(e);
    enemies.push(e);
    spawnDelay = Math.max(500, spawnDelay * 0.97);
  }

  function shoot(){
    const dir = new THREE.Vector3(Math.sin(yaw), 0, Math.cos(yaw));
    const mesh = new THREE.Mesh(
      new THREE.SphereGeometry(.12,8,8),
      new THREE.MeshBasicMaterial({color:0xffff00})
    );
    mesh.position.copy(player.position)
      .add(new THREE.Vector3(0,1.5,0))
      .add(dir.clone().multiplyScalar(1.2));
    scene.add(mesh);
    bullets.push({mesh, dir, life:0});
  }

  function loop(ts){
    const dt = (ts - lastTime)/1000;
    lastTime = ts;

    if(running){
      // spawn
      if(ts - lastSpawn > spawnDelay){
        spawnEnemy();
        lastSpawn = ts;
      }

      // ── movement with arrows FIXED ──
      const dx = (moveR ?  1 : 0) - (moveL ? 1 : 0);
      const dz = (moveB ?  1 : 0) - (moveF ? 1 : 0);
      player.position.x += dx * speed * dt;
      player.position.z += dz * speed * dt;
      player.rotation.y = -yaw;

      // clamp
      player.position.x = clamp(player.position.x, -50, 50);
      player.position.z = clamp(player.position.z, -50, 50);

      // bullets
      bullets = bullets.filter(b=>{
        b.mesh.position.add(b.dir.clone().multiplyScalar(40*dt));
        b.life += dt;
        if(b.life>3){
          scene.remove(b.mesh);
          return false;
        }
        return true;
      });

      // enemies
      enemies = enemies.filter(e=>{
        const toP = new THREE.Vector3().subVectors(player.position,e.position).normalize();
        e.position.add(toP.clone().multiplyScalar(e.userData.speed*dt));
        e.lookAt(player.position);

        if(e.position.distanceTo(player.position)<1){
          hp -= 10;
          hpEl.textContent = hp;
          scene.remove(e);
          return false;
        }
        for(let i=0;i<bullets.length;i++){
          if(bullets[i].mesh.position.distanceTo(e.position)<1.2){
            scene.remove(e);
            scene.remove(bullets[i].mesh);
            bullets.splice(i,1);
            score++;
            scEl.textContent = score;
            return false;
          }
        }
        return true;
      });

      if(hp <= 0 && !gameOver){
        endGame();
      }

      // camera follow
      const off = new THREE.Vector3(
        -Math.sin(yaw)*10, 5, -Math.cos(yaw)*10
      );
      camera.position.copy(player.position).add(off);
      camera.lookAt(player.position);
    }

    renderer.render(scene, camera);
    if(running) requestAnimationFrame(loop);
  }

  function endGame(){
    running = false;
    gameOver = true;
    finalEl.textContent = score;
    fillHighScores();
    gameO.style.display = 'flex';
  }

  function fillHighScores(){
    const arr = JSON.parse(localStorage.getItem(HS_KEY)||'[]')
               .sort((a,b)=>b.s - a.s)
               .slice(0,10);
    hsList.innerHTML = '';
    arr.forEach(({n,s})=>{
      const li = document.createElement('li');
      li.innerHTML = `<span>${n}</span><span>${s}</span>`;
      hsList.appendChild(li);
    });
  }

  function saveHighScore(){
    const name = nameIn.value.trim() || 'Anon';
    const arr = JSON.parse(localStorage.getItem(HS_KEY)||'[]');
    arr.push({n:name, s:score});
    arr.sort((a,b)=>b.s-a.s);
    arr.splice(10);
    localStorage.setItem(HS_KEY, JSON.stringify(arr));
    nameIn.disabled = true;
    saveBtn.disabled = true;
    fillHighScores();
  }
  </script>
</body>
</html>